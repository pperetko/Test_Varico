unit WydrukZUS3;

interface

uses Database, dialogs, classes, sysUtils;
type
  TosWydrukZUS3 = class(TObject)
  private
    Fid: Integer;
    function PrzygotujRaport: TresultHandle;
  public
    constructor Create(Aid: Integer);
    procedure PokazWydruk;
    procedure EksportujWydruk;
  end;

implementation
uses DMPrint, frxClass, frxADOComponents, funkcje, DateUtils;
{ TosWydrukZUS3 }

constructor TosWydrukZUS3.Create(Aid: Integer);
begin
  Fid := Aid;
end;

procedure TosWydrukZUS3.EksportujWydruk;
var
  xFilename: string;
  xFileStream: TFileStream;
  xResultHandle: TResultHandle;
begin
  xFileStream := nil;
  xFilename := 'Zus3_' + IntToStr(MilliSecondOfTheYear(now)) + '.pdf';
  try
    xFileStream := TFileStream.Create(IncludeTrailingPathDelimiter(GdataBase.foldereksport) + xFilename
      , fmCreate or fmShareDenyNone);
    GDataModuleReport.frxPDFExport.Stream := xFileStream;
    PrzygotujRaport;
    GDataModuleReport.frxReport.PrepareReport(true);
    if GDataModuleReport.frxReport.Export(GDataModuleReport.frxPDFExport) then begin
      ShowMessage('Eksport zosta³ wykonany poprawnie.');
      xResultHandle := TResultHandle.CreateSQL(
        format(' Insert Into public.plik(sciezka,nazwa) values(''%s'',''%s'')', [GdataBase.foldereksport, xFilename]));
      xResultHandle.ExecuteSql;
      xResultHandle.Free;
    end else begin
      ShowMessage('Wyst¹pi³ b³¹d eksportu. Proszê siê skontaktowa z serwisem.');
    end;
  finally
    xFileStream.Free;
  end;
end;

procedure TosWydrukZUS3.PokazWydruk;
var
  xResultHandle: TResultHandle;
begin
  xResultHandle := PrzygotujRaport;
  try
    if xResultHandle.RecordCount > 0 then begin
      GDataModuleReport.frxReport.PrepareReport(false);
      GDataModuleReport.frxReport.ShowPreparedReport;
      xResultHandle.free;
    end else begin
      ShowMessage('Brak danych do wydruku.');
    end;
  except
    ShowMessage('Nieprawidlowy wydruk.');
  end;
end;

function TosWydrukZUS3.PrzygotujRaport: TresultHandle;
var
  xPath: string;
  xQuery: string;
begin
  xQuery := format(
    ' Select Platnik.nip as platnik_nip, Platnik.regon as platnik_regon, Platnik.pesel as platnik_pesel, ' +
    ' Platnik.rodzajdokumentu as platnik_rodzajDok, Platnik.serianumerdok  as platnik_seriaDok, ' +
    ' Platnik.nazwaskrocona as platnik_nazwaSkr,platnik.nazwisko as platnik_nazwisko, ' +
    ' Platnik.imie as platnik_imie, ' +
    ' Pracownik.Pesel as prac_pesel, Pracownik.rodzajdokumentu as prac_rodzajDok, Pracownik.serianumerdokumentu as prac_seriaDok,' +
    ' Pracownik.nazwisko as prac_nazwisko, Pracownik.imie as prac_imie, to_char(Pracownik.dataurodzenia,''dd-mm-yyyy'') as prac_dataUrodzenia,' +
    ' Adres.kodpocztowy as adres_kodPocztowy, Adres.poczta  as adres_poczta, Adres.gmina as adres_gmina, ' +
    ' Adres.miejscowosc as adres_miejscowosc, Adres.ulica as adres_ulica, Adres.numerdomu as adres_numerdomu ,' +
    ' Adres.numerlokalu as adres_numerLokalu, Adres.numertelefonu as adres_numertelefonu , Adres.symbolpanstwa as adres_symbolpanstwa,' +
    ' Adres.kodpocztowyzagr as adres_kodPocztowyzagr, Adres.nazwapanstwa as adres_nazwaPanstwa, Adres.email as adres_email ' +
    ' from public.Platnik ' +
    ' join public.Adres on Adres.idAdres=platnik.idAdresSiedziby ' +
    ' join public.Pracownik on Pracownik.idPracownik=Platnik.idPracownik ' +
    ' where Platnik.idPlatnik=%s', [intToStr(Fid)]);
  result := TResultHandle.CreateSQL(xQuery);
  result.InvokeSql;
  xPath := PodajPathSystem + 'Zus3.fr3';
  GDataModuleReport.frxReport.LoadFromFile(xPath);
  GDataModuleReport.DataSource1.DataSet := result;
end;

end.

